<!DOCTYPE html>
<html>
<head>
  <title>Dialtone Swarm Dashboard</title>
  <style>
    :root {
      color-scheme: dark;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #0f1115;
      color: #d1d5db;
      padding: 2rem;
    }
    h1 {
      margin: 0;
      color: #f9fafb;
      font-size: 1.6rem;
    }
    .subtitle {
      margin: 0.25rem 0 0;
      color: #9ca3af;
      font-size: 0.9rem;
    }
    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .form-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1.25rem;
    }
    .input {
      padding: 0.55rem 0.75rem;
      border-radius: 8px;
      border: 1px solid #2b2f36;
      background: #111827;
      color: #e5e7eb;
      min-width: 200px;
    }
    .btn {
      border: none;
      border-radius: 8px;
      padding: 0.55rem 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: #3b82f6; color: #fff; }
    .btn-secondary { background: #6b7280; color: #fff; }
    .btn-danger { background: #ef4444; color: #fff; }
    .hint {
      margin: 0 0 1.5rem;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      background: #1f2937;
      color: #d1d5db;
      font-size: 0.9rem;
    }
    .hint.error {
      background: #3f1d1d;
      color: #fca5a5;
    }
    .node-card {
      background: #111827;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid #1f2937;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .node-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #1f2937;
      padding-bottom: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .status-running { color: #22c55e; }
    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      color: #9ca3af;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    .latency { font-size: 0.85rem; color: #9ca3af; }
    .peer-list { font-size: 0.9rem; list-style: none; padding: 0; margin: 0.5rem 0 0; }
    .peer-id { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; color: #e5e7eb; }
  </style>
</head>
<body>
  <div class="toolbar">
    <div>
      <h1>Swarm Dashboard</h1>
      <p class="subtitle">Muted UI, live status, Pear runtime</p>
    </div>
  </div>
  <div class="form-row">
    <input id="nameInput" class="input" placeholder="instance name (e.g. alpha)" />
    <input id="topicInput" class="input" placeholder="topic name (e.g. dialtone-demo)" />
    <button class="btn btn-primary" id="newBtn">New</button>
  </div>
  <div id="commandHint" class="hint">Tip: start/stop buttons copy the command for your terminal.</div>
  <div id="nodes">Loading nodes...</div>

  <script type="module">
    let latestNodes = []

    function setHint(message, isError = false) {
      const hint = document.getElementById('commandHint')
      hint.textContent = message
      hint.classList.toggle('error', isError)
    }

    async function postJson(url, payload) {
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      const data = await response.json().catch(() => ({}))
      if (!response.ok) {
        throw new Error(data.error || `HTTP ${response.status}`)
      }
      return data
    }

    function randomTopic() {
      return `swarm-${Math.random().toString(36).slice(2, 8)}`
    }

    async function refresh() {
      try {
        const response = await fetch('/status', { cache: 'no-store' })
        if (!response.ok) throw new Error(`HTTP ${response.status}`)
        const payload = await response.json()

        if (payload.error) {
          throw new Error(payload.error)
        }

        const nodes = payload.nodes || []
        latestNodes = nodes
        let html = ''
        if (nodes.length === 0) {
          html = '<p>No active nodes found.</p>'
        }

        nodes.forEach(status => {
          const latencies = Object.values(status.latencies || {})
          const avgLatency = latencies.length
            ? `${(latencies.reduce((sum, val) => sum + Number(val || 0), 0) / latencies.length).toFixed(2)}ms`
            : 'n/a'
          const instanceName = status.name || 'unnamed'
          html += `
            <div class="node-card">
              <div class="node-header">
                <strong>Instance: ${instanceName}</strong>
                <span class="status-running">‚óè Running (PID: ${status.pid || 'n/a'})</span>
              </div>
              <div class="meta-row">
                <div>Topic: ${status.topic || 'dialtone-default'}</div>
                <div>Peers: ${status.peers ?? 0}</div>
                <div>Avg latency: ${avgLatency}</div>
              </div>
              <div class="actions">
                <button class="btn btn-secondary" data-action="start" data-topic="${status.topic || ''}" data-name="${instanceName}">Start</button>
                <button class="btn btn-danger" data-action="stop" data-pid="${status.pid || ''}">Stop</button>
              </div>
              <ul class="peer-list">
                ${Object.entries(status.latencies || {}).map(([id, lat]) => `
                  <li>
                    <span class="peer-id">${id}</span>: 
                    <span class="latency">${lat}ms</span>
                  </li>
                `).join('')}
              </ul>
              <div class="latency">Last Updated: ${status.updated ? new Date(status.updated).toLocaleTimeString() : 'n/a'}</div>
            </div>
          `
        })
        document.getElementById('nodes').innerHTML = html
      } catch (err) {
        document.getElementById('nodes').innerHTML = `<p style="color:red">Error: ${err.message}</p>`
      }
    }

    document.getElementById('newBtn').addEventListener('click', async () => {
      const nameInput = document.getElementById('nameInput')
      const topicInput = document.getElementById('topicInput')
      const topic = topicInput.value.trim() || randomTopic()
      const name = nameInput.value.trim() || `node-${Math.random().toString(36).slice(2, 6)}`
      nameInput.value = name
      topicInput.value = topic
      try {
        await postJson('/start', { topic, name })
        setHint(`Started ${name} on ${topic}`)
        refresh()
      } catch (err) {
        setHint(err.message, true)
      }
    })

    document.getElementById('nodes').addEventListener('click', async (event) => {
      const target = event.target
      if (!(target instanceof HTMLElement)) return
      const button = target.closest('button[data-action]')
      if (!button) return
      const action = button.getAttribute('data-action')
      try {
        if (action === 'start') {
          const topic = button.getAttribute('data-topic') || ''
          const name = button.getAttribute('data-name') || ''
          if (!topic) throw new Error('Missing topic for start')
          await postJson('/start', { topic, name })
          setHint(`Started ${name || 'node'} on ${topic}`)
        } else if (action === 'stop') {
          const pid = button.getAttribute('data-pid') || ''
          if (!pid) throw new Error('Missing PID for stop')
          await postJson('/stop', { pid })
          setHint(`Stopped PID ${pid}`)
        }
        refresh()
      } catch (err) {
        setHint(err.message, true)
      }
    })

    refresh()
    setInterval(refresh, 2000)
  </script>
</body>
</html>
