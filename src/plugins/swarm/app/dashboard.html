<!DOCTYPE html>
<html>
<head>
  <title>Dialtone Swarm Dashboard</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #0f172a; color: #f1f5f9; padding: 2rem; }
    h1 { color: #38bdf8; }
    .node-card { background: #1e293b; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; border: 1px solid #334155; }
    .node-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; padding-bottom: 0.5rem; margin-bottom: 0.5rem; }
    .status-running { color: #4ade80; }
    .latency { font-size: 0.8rem; color: #94a3b8; }
    .peer-list { font-size: 0.9rem; list-style: none; padding: 0; }
    .peer-id { font-family: monospace; color: #cbd5e1; }
  </style>
</head>
<body>
  <h1>Swarm Dashboard</h1>
  <div id="nodes">Loading nodes...</div>

  <script type="module">
    import fs from 'bare-fs'
    import path from 'bare-path'
    import os from 'bare-os'

    const registryPath = path.join(os.homedir(), '.dialtone', 'swarm', 'nodes.json')
    const swarmDir = path.join(os.homedir(), '.dialtone', 'swarm')

    function refresh() {
      try {
        const files = fs.readdirSync(swarmDir)
        const statusFiles = files.filter(f => f.startsWith('status_'))
        
        let html = ''
        if (statusFiles.length === 0) {
          html = '<p>No active nodes found.</p>'
        }

        statusFiles.forEach(file => {
          const data = fs.readFileSync(path.join(swarmDir, file))
          const status = JSON.parse(data)
          
          html += `
            <div class="node-card">
              <div class="node-header">
                <strong>Topic: ${status.topic}</strong>
                <span class="status-running">‚óè Running (PID: ${status.pid})</span>
              </div>
              <div>Peers: ${status.peers}</div>
              <ul class="peer-list">
                ${Object.entries(status.latencies).map(([id, lat]) => `
                  <li>
                    <span class="peer-id">${id}</span>: 
                    <span class="latency">${lat}ms</span>
                  </li>
                `).join('')}
              </ul>
              <div class="latency">Last Updated: ${new Date(status.updated).toLocaleTimeString()}</div>
            </div>
          `
        })
        document.getElementById('nodes').innerHTML = html
      } catch (err) {
        document.getElementById('nodes').innerHTML = `<p style="color:red">Error: ${err.message}</p>`
      }
    }

    refresh()
    setInterval(refresh, 2000)
  </script>
</body>
</html>
